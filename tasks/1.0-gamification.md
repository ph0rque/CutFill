
# Plan of Action for Implementing Multi-Level Competitive Gameplay in CutFill

Based on the review of Cursor rules, Memory Bank, and codebase, this plan transforms existing assignments into competitive multi-level gameplay. It aligns with the Game Week Project Guide, building on assignments as objectives, multiplayer via Socket.io/Supabase, and progress tracking.

The plan is divided into phases for a 3-5 day implementation.

## Phase 1: Preparation and Restructuring (1-2 hours)
- **Goal:** Repurpose assignments as levels without breaking existing single-player functionality.
- **Steps:**
  1. In `src/src/assignments.ts`:
     - Add a `levelNumber: number` field to `AssignmentConfig` interface (e.g., assign levels 1-10 based on `difficulty` or manually sequence the templates in `getAssignmentTemplates()`).
     - Update `AssignmentManager` to include level progression: Add methods like `getAvailableLevels()` (filter assignments by unlocked status) and `unlockNextLevel()` (called on completion, updating user progress in Supabase via `updateUserProgress()`).
     - Integrate net-zero scoring: In `evaluateObjective()`, add a new objective type (e.g., `'net_zero'`) that scores based on `Math.abs(volumeData.netMovement)` (e.g., full points if <5% tolerance, scaled down otherwise). Weight it at 30% of total score.
  2. In `src/src/progress.ts`:
     - Extend `UserProgress` with `unlockedLevels: number[]` and `levelScores: Record<number, { score: number; operations: number; netVolume: number }>` for tracking per-level performance.
     - Update `updateUserProgress()` to record level-specific data and unlock the next level (e.g., if level 1 completed, unlock level 2).
  3. Database updates (in `src/src/supabase.ts` or via Supabase dashboard):
     - Add columns to `user_progress` table: `unlocked_levels` (array of integers) and `level_scores` (JSONB for per-level data).
     - Ensure assignments table supports leveling (add `level_number` column and populate for existing templates).
- **Rationale:** Builds on existing assignment templates (e.g., 'foundation_prep_1' becomes Level 1) and progress tracking. No new files needed yet.
- **Potential Challenges:** Ensure backward compatibility for non-competitive play; test with guest users (who skip DB saves).

## Phase 2: Implement Multi-Level Progression (4-6 hours)
- **Goal:** Create a multi-level system where players advance through sequenced assignments.
- **Steps:**
  1. In `src/src/assignment-ui.ts`:
     - Update UI to display "Levels" instead of "Assignments" (e.g., rename modal to "Level Selection" and show locked/unlocked status with icons like ðŸ”’ for locked levels).
     - Add progression visualization: A progress bar showing unlocked levels (e.g., "Level 1/10 Unlocked") tied to `UserProgress.unlockedLevels`.
  2. In `src/src/assignments.ts`:
     - Modify `startAssignment()` to validate level unlocking (e.g., check if `levelNumber` is in user's unlocked levels).
     - On completion (in `completeAssignment()`), call `unlockNextLevel()` and award XP (e.g., base 100 XP + bonuses for net-zero and low operations).
  3. Add operation counting:
     - In `AssignmentProgress`, add `operationCount: number` (increment in `addToolUsage()` or during terrain mods in `main.ts`/`precision-tools.ts`).
     - Score it: In `updateProgress()`, add a metric where fewer operations = higher points (e.g., normalize against an "ideal" count per level, weighted at 20% of score).
- **Rationale:** Leverages existing `AssignmentManager` for sequencing; ties into `progress.ts` for XP-based unlocks (e.g., start with Level 1 unlocked, require 70%+ score to unlock next).
- **Testing:** Simulate single-player level progression; verify unlocks persist via Supabase.

## Phase 3: Add Competitive Multiplayer (6-8 hours)
- **Goal:** Enable 2+ players to compete on the same level with real-time scoring.
- **Steps:**
  1. In `src/src/multiplayer-enhanced.ts`:
     - Extend `GameSession` with `currentLevel: number` and `levelScores: Record<string, { objectivePoints: number; netZeroPoints: number; operationsPoints: number; total: number }>` (per player).
     - Add events for level start/completion: `startLevel(levelNumber)` emits to server, syncing terrain and objectives for all players.
     - In `modifyTerrain()`, track operations per player and broadcast (e.g., increment player's operation count in session state).
  2. In `src/src/collaborative-features.ts`:
     - Create a new assignment type `'competitive_level'` in `initializeCollaborativeAssignments()` (extend existing competitive templates like 'speed_foundation_race').
     - In `updateTeamProgress()`, adapt for competition: Calculate per-player scores in real-time (e.g., objective completion: 50% of points, net-zero closeness: 30%, least operations: 20%). Use `progress` maps for individual tracking.
     - Add leaderboard sync: Every 5s, emit updated scores to all players.
  3. Integrate with assignments:
     - In `AssignmentManager.startAssignment()`, if in multiplayer session, set mode to competitive and sync via `multiplayerManager`.
     - On level end, rank players (e.g., winner gets bonus XP in `progress.ts`).
  4. Handle net-zero and operations in scoring:
     - Net-zero: Score = 100 * (1 - (abs(netMovement) / totalVolume)), synced per player.
     - Operations: Score = 100 * (minOperations / playerOperations), where minOperations is a level-defined ideal (add to `AssignmentConfig`).
- **Rationale:** Builds on existing competitive templates and shared objectives; ensures low-latency via Socket.io (e.g., broadcast mods and scores).
- **Testing:** Host 2-4 player sessions; verify real-time score updates and winner determination.

## Phase 4: UI and Feedback Enhancements (4-6 hours)
- **Goal:** Make competition visible and engaging.
- **Steps:**
  1. In `src/src/multiplayer-ui.ts`:
     - Add a leaderboard panel showing real-time scores (e.g., "Player1: 85 pts (Objectives: 50, Net-Zero: 25, Operations: 10)").
     - Display level-specific UI (e.g., "Competing on Level 3: Road Grading" with timers).
  2. In `src/src/assignment-ui.ts` and `assignment-feedback.ts`:
     - Update progress indicators to show competitive rankings (e.g., color-coded bars for net-zero and operations).
     - Add post-level summary: "You ranked #2! Points Breakdown: ..."
  3. In `src/src/main.ts`:
     - Add UI buttons for "Join Competitive Level" (integrates with multiplayer session creation).
- **Rationale:** Enhances engagement per `productContext.md` (e.g., social learning); reuses existing UI components.

## Phase 5: Testing, Polish, and Documentation (2-4 hours)
- **Steps:**
  1. Test edge cases: 2-player vs. 4-player, ties in scoring, disconnects (use graceful degradation in `multiplayer-enhanced.ts`).
  2. Performance: Ensure 60+ FPS during competitive play (leverage existing optimizations in `systemPatterns.md`).
  3. Update Memory Bank:
     - `activeContext.md`: Add notes on new competitive levels.
     - `progress.md`: Mark multiplayer competition as complete.
     - Create `.cursor/rules/levels.mdc` for patterns (e.g., "Levels must include net-zero scoring with <5% tolerance").
  4. Deploy and demo: Update README with competitive mode instructions.
- **Success Metrics:** Per `assignment.md`, test for fun/engagement (e.g., playtest with 2 players), performance (<50ms latency), and progression (unlock 3+ levels).

This plan turns CutFill into a multi-level competitive game while preserving its educational core. 