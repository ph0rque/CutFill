
# Plan of Action for Implementing Multi-Level Competitive Gameplay in CutFill

Based on the review of Cursor rules, Memory Bank, and codebase, this plan transforms existing assignments into competitive multi-level gameplay. It aligns with the Game Week Project Guide, building on assignments as objectives, multiplayer via Socket.io/Supabase, and progress tracking.

The plan is divided into phases for a 3-5 day implementation, following a **linear level progression** model (completing Level N unlocks Level N+1).

## Phase 1: Preparation and Restructuring (1-2 hours)
- **Goal:** Repurpose assignments as levels and establish the data structure for scoring and progression.
- **Steps:**
  1. In `src/src/assignments.ts`:
     - Add `levelNumber: number` and `idealOperations: number` fields to the `AssignmentConfig` interface. This sets the level sequence and the "par" for operation efficiency scoring.
     - Update `AssignmentManager` to manage level progression (e.g., `getAvailableLevels`, `unlockNextLevel`).
     - Integrate net-zero scoring as a new objective type (`'net_zero'`) in `evaluateObjective`, weighted at 30% of the total score.
  2. In `src/src/progress.ts`:
     - Extend the `UserProgress` interface with `unlockedLevels: number[]` to track which levels the player can access.
     - Update `updateUserProgress()` to push the next level ID to `unlockedLevels` upon successful completion.
  3. **Database Schema Update**:
     - Create a new table named `level_attempts` to store results from every competitive match. This provides robust data for leaderboards and personal bests.
       - **Columns**: `id`, `user_id`, `level_id`, `score`, `operations_count`, `net_volume`, `duration_seconds`, `completed_at`.
     - In the existing `user_progress` table, add an `unlocked_levels` column (integer array).
- **Rationale:** Establishes a solid, scalable foundation for tracking scores and progression. Creating a dedicated table for attempts is better for querying leaderboards than using a JSONB column.
- **Potential Challenges:** Migrating any existing user progress if applicable.

## Phase 2: Implement Multi-Level Progression (4-6 hours)
- **Goal:** Create a multi-level system where players advance through sequenced levels, with an option for solo practice.
- **Steps:**
  1. In `src/src/assignment-ui.ts`:
     - Overhaul the assignments modal to be a "Level Selection" screen.
     - Display levels, showing their locked/unlocked status (e.g., with a ðŸ”’ icon).
     - For each unlocked level, provide two options: **"Practice"** (single-player mode) and **"Compete"** (initiates a multiplayer lobby).
  2. In `src/src/assignments.ts`:
     - Modify `startAssignment()` to check if a level is in the user's `unlockedLevels` array before starting.
     - On level completion, call `unlockNextLevel()` and award XP.
  3. **Implement Operation Counting & Scoring**:
     - In `AssignmentProgress`, add `operationCount: number`. Increment it on each terrain modification.
     - In `updateProgress()`, add a scoring metric for operations: `Score = 100 * (idealOperations / playerOperations)`. This score component is weighted at 20% of the final score.
- **Rationale:** Introduces the core gameplay loop of unlocking and playing levels, while providing a non-competitive practice mode as requested.
- **Testing:** Simulate a single-player completing a level, verifying the next level unlocks and the result is saved correctly.

## Phase 3: Add Competitive Multiplayer (6-8 hours)
- **Goal:** Enable 2+ players to compete on a level with real-time scoring, following a lobby-first approach.
- **Steps:**
  1. In `src/src/multiplayer-enhanced.ts`:
     - Extend `GameSession` to include `currentLevel: number` and a `liveScores` object to hold real-time scores for all players.
     - Implement the "lobby-first" flow: A player hosting a session selects a level to compete on. The match can only start with a **minimum of two players** in the session.
  2. **Implement Real-Time Score Synchronization**:
     - Broadcast score updates **instantly** after any player action that changes a score (e.g., completing an objective, modifying terrain).
     - As a fallback, also broadcast a full score-sync for all players every 5 seconds to ensure consistency.
  3. In `src/src/collaborative-features.ts`:
     - Adapt or create a new `'competitive_level'` assignment type.
     - In `updateTeamProgress()`, modify it to calculate and update individual player scores based on the three criteria (objective completion: 50%, net-zero balance: 30%, operation efficiency: 20%).
     - On level end, determine player rankings and save each player's results to the new `level_attempts` table. Award bonus XP to the winner.
- **Rationale:** Builds on the existing multiplayer foundation to create a dynamic, responsive competitive experience.
- **Testing:** Host 2-4 player sessions. Verify that scores update in real-time for all participants and that the final results are recorded correctly.

## Phase 4: UI and Feedback Enhancements (4-6 hours)
- **Goal:** Make competition visible, intuitive, and engaging.
- **Steps:**
  1. In `src/src/multiplayer-ui.ts`:
     - Implement a real-time leaderboard panel, visible during competitive matches, showing each player's ranked score and a breakdown of points.
  2. In `src/src/assignment-ui.ts` and `assignment-feedback.ts`:
     - For practice mode, show progress against the level's objectives.
     - For competitive mode, show progress relative to other players.
     - Create a post-game summary screen showing final rankings and a detailed breakdown of points for each player.
  3. In `src/src/main.ts`:
     - Ensure the "Join Competitive Level" button in the UI properly hooks into the multiplayer session/lobby creation flow.
- **Rationale:** Provides the necessary feedback to make the competition feel meaningful and fun.

## Phase 5: Testing, Polish, and Documentation (2-4 hours)
- **Steps:**
  1. Test edge cases: 2-player vs. 4-player, score ties, player disconnects.
  2. Performance: Ensure 60+ FPS is maintained during competitive play.
  3. Update Memory Bank and Rules:
     - `activeContext.md`: Note the new competitive level system.
     - `progress.md`: Mark multiplayer competition as a completed feature.
     - `.cursor/rules/levels.mdc`: Document patterns for level design (e.g., "Competitive levels must have a defined `idealOperations` count.").
  4. Demo: Update README with instructions for starting both practice and competitive modes.
- **Success Metrics:** Fun/engagement, low-latency performance, and a clear, functional progression system.

This updated plan provides a clear path to implementing the multi-level competitive game as you've envisioned. 